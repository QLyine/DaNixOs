#!/usr/bin/env bash

# Secrets Management Helper Script
# This script provides convenient commands for managing SOPS secrets

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SECRETS_DIR="$(dirname "$0")/../secrets"
DOTFILES_DIR="$(dirname "$0")/.."
AGE_KEY_FILE="$SECRETS_DIR/keys/age-key.txt"

# Helper functions
print_usage() {
    echo -e "${BLUE}Secrets Management Helper${NC}"
    echo ""
    echo "Usage: $0 <command> [options]"
    echo ""
    echo "Commands:"
    echo "  edit <file>           Edit an encrypted secrets file"
    echo "  create <file>         Create a new encrypted secrets file"
    echo "  view <file>           Decrypt and view a secrets file"
    echo "  list <file>           List all keys in a secrets file"
    echo "  get <file> <key>      Get a specific secret value"
    echo "  export <file>         Export all secrets as environment variables"
    echo "  backup                Create a backup of the age key"
    echo "  restore <backup>      Restore age key from backup"
    echo "  check                 Check configuration and setup"
    echo "  init                  Initialize secrets for a new machine"
    echo "  help                  Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 edit user/secrets.d/api-keys.yaml"
    echo "  $0 get user/secrets.d/api-keys.yaml github_token"
    echo "  $0 export user/secrets.d/api-keys.yaml"
    echo "  $0 backup"
}

error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}✓ $1${NC}"
}

info() {
    echo -e "${BLUE}ℹ $1${NC}"
}

warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

check_setup() {
    info "Checking SOPS and age setup..."

    # Check if age is installed
    if ! command -v age &> /dev/null; then
        error "age is not installed. Please install it first."
    fi

    # Check if sops is installed
    if ! command -v sops &> /dev/null; then
        error "sops is not installed. Please install it first."
    fi

    # Check if age key exists
    if [[ ! -f "$AGE_KEY_FILE" ]]; then
        error "Age key not found at $AGE_KEY_FILE"
    fi

    # Check if SOPS config exists
    if [[ ! -f "$DOTFILES_DIR/.sops.yaml" ]]; then
        error "SOPS configuration not found at $DOTFILES_DIR/.sops.yaml"
    fi

    # Extract public key from age key file
    local public_key
    public_key=$(grep "public key:" "$AGE_KEY_FILE" | cut -d':' -f2 | tr -d ' ')

    # Check if public key is in SOPS config
    if ! grep -q "$public_key" "$DOTFILES_DIR/.sops.yaml"; then
        warning "Public key not found in SOPS configuration"
    fi

    success "Setup looks good!"
    info "Public key: $public_key"
}

edit_secrets() {
    local file="$1"
    local full_path="$SECRETS_DIR/$file"

    if [[ ! -f "$full_path" ]]; then
        error "Secrets file not found: $full_path"
    fi

    info "Opening $file for editing..."
    sops "$full_path"
    success "File encrypted and saved"
}

create_secrets() {
    local file="$1"
    local full_path="$SECRETS_DIR/$file"

    if [[ -f "$full_path" ]]; then
        error "Secrets file already exists: $full_path"
    fi

    # Create directory if it doesn't exist
    mkdir -p "$(dirname "$full_path")"

    info "Creating new secrets file: $file"

    # Create a template file
    local template_file
    template_file=$(mktemp)
    cat > "$template_file" << 'EOF'
# Secrets configuration
# Add your secrets below in key: value format

# Example:
# service_api_key: "your-api-key-here"
# database_password: "your-database-password"
EOF

    sops --encrypt "$template_file" > "$full_path"
    rm "$template_file"

    # Now open for editing
    edit_secrets "$file"
}

view_secrets() {
    local file="$1"
    local full_path="$SECRETS_DIR/$file"

    if [[ ! -f "$full_path" ]]; then
        error "Secrets file not found: $full_path"
    fi

    sops -d "$full_path"
}

list_secrets() {
    local file="$1"
    local full_path="$SECRETS_DIR/$file"

    if [[ ! -f "$full_path" ]]; then
        error "Secrets file not found: $full_path"
    fi

    info "Secrets in $file:"
    sops -d "$full_path" | grep -v '^sops:' | grep -v '^#' | grep ':' | cut -d':' -f1 | sed 's/^ *//'
}

get_secret() {
    local file="$1"
    local key="$2"
    local full_path="$SECRETS_DIR/$file"

    if [[ ! -f "$full_path" ]]; then
        error "Secrets file not found: $full_path"
    fi

    if [[ -z "$key" ]]; then
        error "Key not specified"
    fi

    sops -d "$full_path" | grep "^$key:" | cut -d':' -f2- | sed 's/^ *//' | tr -d '"'
}

export_secrets() {
    local file="$1"
    local full_path="$SECRETS_DIR/$file"

    if [[ ! -f "$full_path" ]]; then
        error "Secrets file not found: $full_path"
    fi

    info "Exporting secrets from $file..."
    while IFS=':' read -r key value; do
        # Skip SOPS metadata and comments
        if [[ "$key" =~ ^(sops|#|$) ]]; then
            continue
        fi

        # Clean up the key and value
        key=$(echo "$key" | tr -d ' ')
        value=$(echo "$value" | sed 's/^ *//' | tr -d '"')

        # Export as environment variable
        export "$(echo "$key" | tr '[:lower:]' '[:upper:]' | tr '-' '_')"="$value"
        echo "Exported $key"
    done < <(sops -d "$full_path")
    success "Secrets exported as environment variables"
}

backup_age_key() {
    local backup_dir="${1:-$HOME/Downloads}"
    local backup_file="$backup_dir/age-key-backup-$(date +%Y%m%d-%H%M%S).txt"

    if [[ ! -f "$AGE_KEY_FILE" ]]; then
        error "Age key not found at $AGE_KEY_FILE"
    fi

    cp "$AGE_KEY_FILE" "$backup_file"
    success "Age key backed up to: $backup_file"
    warning "Keep this backup safe and secure!"
}

restore_age_key() {
    local backup_file="$1"

    if [[ -z "$backup_file" ]]; then
        error "Backup file not specified"
    fi

    if [[ ! -f "$backup_file" ]]; then
        error "Backup file not found: $backup_file"
    fi

    # Create backup directory if it doesn't exist
    mkdir -p "$(dirname "$AGE_KEY_FILE")"

    cp "$backup_file" "$AGE_KEY_FILE"
    chmod 600 "$AGE_KEY_FILE"
    success "Age key restored from: $backup_file"
}

init_secrets() {
    info "Initializing secrets setup for this machine..."

    # Create directories
    mkdir -p "$SECRETS_DIR/keys"
    mkdir -p "$SECRETS_DIR/user/secrets.d"

    # Generate new age key if it doesn't exist
    if [[ ! -f "$AGE_KEY_FILE" ]]; then
        info "Generating new age key..."
        age-keygen -o "$AGE_KEY_FILE"
        chmod 600 "$AGE_KEY_FILE"
        success "Age key generated"
    else
        info "Age key already exists"
    fi

    # Extract public key
    local public_key
    public_key=$(grep "public key:" "$AGE_KEY_FILE" | cut -d' ' -f3)

    info "Your public key is: $public_key"
    info "Add this key to .sops.yaml for encrypted files"

    # Create initial secrets file if it doesn't exist
    local initial_secrets="$SECRETS_DIR/user/secrets.d/api-keys.yaml"
    if [[ ! -f "$initial_secrets" ]]; then
        info "Creating initial secrets file template..."
        cat > /tmp/api-keys-template.yaml << 'EOF'
# API keys and tokens
# Replace these with your actual secrets

github_token: "ghp_your_github_token_here"
openai_api_key: "sk-your-openai-key-here"
anthropic_api_key: "sk-ant-your-anthropic-key-here"
EOF

        sops --encrypt --age "$public_key" /tmp/api-keys-template.yaml > "$initial_secrets"
        rm /tmp/api-keys-template.yaml
        success "Initial secrets file created"
    fi

    success "Secrets setup complete!"
    warning "Remember to backup your age key: $0 backup"
}

# Main command dispatcher
case "${1:-help}" in
    edit)
        if [[ $# -ne 2 ]]; then
            error "Usage: $0 edit <file>"
        fi
        check_setup
        edit_secrets "$2"
        ;;
    create)
        if [[ $# -ne 2 ]]; then
            error "Usage: $0 create <file>"
        fi
        check_setup
        create_secrets "$2"
        ;;
    view)
        if [[ $# -ne 2 ]]; then
            error "Usage: $0 view <file>"
        fi
        check_setup
        view_secrets "$2"
        ;;
    list)
        if [[ $# -ne 2 ]]; then
            error "Usage: $0 list <file>"
        fi
        check_setup
        list_secrets "$2"
        ;;
    get)
        if [[ $# -ne 3 ]]; then
            error "Usage: $0 get <file> <key>"
        fi
        check_setup
        get_secret "$2" "$3"
        ;;
    export)
        if [[ $# -ne 2 ]]; then
            error "Usage: $0 export <file>"
        fi
        check_setup
        export_secrets "$2"
        ;;
    backup)
        check_setup
        backup_age_key "${2:-}"
        ;;
    restore)
        if [[ $# -ne 2 ]]; then
            error "Usage: $0 restore <backup_file>"
        fi
        restore_age_key "$2"
        ;;
    check)
        check_setup
        ;;
    init)
        init_secrets
        ;;
    help|--help|-h)
        print_usage
        ;;
    *)
        error "Unknown command: $1. Use '$0 help' for usage information."
        ;;
esac